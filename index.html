<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <meta charset="UTF-8">
  <title>Tic Tac Toe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root {
      --bg: #f5f5f5;
      --text: #333;
      --cell-bg: white;
      --hover-bg: #f0f0f0;
      --x-color: #2c3e50;
      --highlight-X: #3498db;
      --button-bg: #3498db;
      --button-text: #fff;
      --o-color: #e74c3c;
      --moon-color: #111;
    }
    body.dark {
      --bg: #111;
      --text: #f5f5f5;
      --cell-bg: #1e1e1e;
      --hover-bg: #333;
      --x-color: #e1e5eb;
      --highlight-X: #e1e5eb;
      --button-bg: #e1e5eb;
      --button-text: #111;
      --o-color: #e74c3c;
      --moon-color: #f5f5f5;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 12px;
      margin-top: 40px;
      margin-bottom: 20px;
    }
    .cell {
      background: var(--cell-bg);
      border: 2px solid #ccc;
      border-radius: 12px;
      font-size: 4.2rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      color: var(--x-color);
    }
    .cell:active { transform: scale(1.05); }
    .cell:hover { background: var(--hover-bg); }
    .X { color: var(--x-color); text-shadow: 1px 1px 4px #7f8c8d; }
    .O { color: var(--o-color); text-shadow: 1px 1px 4px #ffaaaa; }
    .win.X, .win.O {
      box-shadow: 0 0 20px var(--highlight-X);
      animation: shake 0.5s, pulse 2s infinite;
    }
    @keyframes shake {
      0% { transform: translate(0); }
      25% { transform: translate(-5px, 0); }
      50% { transform: translate(5px, 0); }
      75% { transform: translate(-5px, 0); }
      100% { transform: translate(0); }
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    #newGameBtn, #payBtn {
      font-size: 1.2rem;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
    }
    #newGameBtn {
      background: none;
      color: var(--moon-color);
      text-decoration: underline;
      display: none;
    }
    #newGameBtn.visible { display: block; }
    #payBtn {
      background: var(--button-bg);
      color: var(--button-text);
      display: block;
    }
    #darkToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: none;
      border: none;
      cursor: pointer;
    }
    #darkToggle svg { width: 42px; height: 42px; fill: var(--text); }
  </style>
</head>
<body>

<div id="game"></div>
<button id="newGameBtn" onclick="startNewGame()">New Game</button>
<button id="payBtn" onclick="processPiPayment()">Pay with Pi</button>
<button id="darkToggle" onclick="toggleDarkMode()" aria-label="Toggle Theme">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64 13.06A9 9 0 0 1 11 2a9 9 0 1 0 10.64 11.06z"/></svg>
</button>

<script>
let currentPlayer = 'X';
let gameBoard = Array(9).fill('');
let gameOver = false;
let gameCount = 0;
let piUserAuthenticated = false;

const winCombos = [
  [0,1,2],[3,4,5],[6,7,8],
  [0,3,6],[1,4,7],[2,5,8],
  [0,4,8],[2,4,6]
];

function renderBoard() {
  const board = document.getElementById("game");
  board.innerHTML = '';
  gameBoard.forEach((val, idx) => {
    const cell = document.createElement('div');
    cell.classList.add('cell');
    if (val) cell.classList.add(val);
    cell.textContent = val;
    cell.addEventListener('click', () => playerMove(idx));
    board.appendChild(cell);
  });
}

function playerMove(index) {
  if (gameOver || gameBoard[index] || currentPlayer !== 'X') return;
  gameBoard[index] = 'X';
  renderBoard();
  if (checkEnd('X')) return;
  currentPlayer = 'O';
  setTimeout(botMove, 400);
}

function botMove() {
  if (gameOver) return;
  const cheatMode = (gameCount + 1) % 2 === 0 && (gameCount + 1) % 10 === 0;
  let move = -1;

  if (!cheatMode) {
    move = findBestMove('O');
    if (move === -1) move = findBestMove('X');
  }

  if (move === -1) {
    const empty = gameBoard.map((v, i) => v === '' ? i : null).filter(i => i !== null);
    move = empty[Math.floor(Math.random() * empty.length)];
  }

  gameBoard[move] = 'O';
  renderBoard();
  if (checkEnd('O')) return;
  currentPlayer = 'X';
}

function findBestMove(player) {
  for (let combo of winCombos) {
    const [a, b, c] = combo;
    const line = [gameBoard[a], gameBoard[b], gameBoard[c]];
    if (line.filter(x => x === player).length === 2 && line.includes('')) {
      return combo[line.indexOf('')];
    }
  }
  return -1;
}

function checkEnd(player) {
  if (checkWin(player)) {
    highlightWin(player);
    endGame();
    return true;
  }
  if (!gameBoard.includes('')) {
    endGame();
    return true;
  }
  return false;
}

function checkWin(player) {
  return winCombos.some(combo => combo.every(i => gameBoard[i] === player));
}

function highlightWin(player) {
  winCombos.forEach(combo => {
    if (combo.every(i => gameBoard[i] === player)) {
      document.querySelectorAll('.cell').forEach((cell, i) => {
        if (combo.includes(i)) cell.classList.add('win', player);
      });
    }
  });
}

function endGame() {
  gameOver = true;
  document.getElementById("newGameBtn").classList.add("visible");
}

function startNewGame() {
  gameOver = false;
  gameBoard = Array(9).fill('');
  document.getElementById("newGameBtn").classList.remove("visible");
  gameCount++;
  // Naizmenično: neparan broj igra čovek prvi, paran broj bot prvi
  const humanStarts = gameCount % 2 === 1;
  currentPlayer = humanStarts ? 'X' : 'O';
  renderBoard();
  if (!humanStarts) setTimeout(botMove, 400);
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
}

function processPiPayment() {
  if (!piUserAuthenticated) return;
  Pi.createPayment({
    amount: 0.01,
    memo: "Tic Tac Toe Game",
    metadata: { purpose: "Game Payment" },
    to: "GD3IVAZNBCCETNA7MT5SHBJXNAIJ7Q44GURPGLBWAUCS2TH4K5PALJHP"
  }, {
    onReadyForServerApproval: (paymentId) => console.log("Approve: ", paymentId),
    onReadyForServerCompletion: (paymentId, txid) => console.log("✅ Payment complete: " + txid),
    onCancel: (paymentId) => console.log("❌ Cancelled: ", paymentId),
    onError: (error) => console.log("❌ Error: " + error.message)
  });
}

window.addEventListener("DOMContentLoaded", () => {
  startNewGame();
  const payBtn = document.getElementById('payBtn');
  payBtn.style.display = 'block';

  if (typeof window.Pi !== 'undefined') {
    Pi.init({ version: "2.0", sandbox: true });
    Pi.authenticate(['payments'], function (payment) {
      console.log('Incomplete payment found:', payment);
    }).then(function (auth) {
      piUserAuthenticated = true;
    }).catch(function (error) {
      console.error('Authentication failed:', error);
    });
  } else {
    console.warn('Pi SDK not loaded. Use Pi Browser.');
  }
});
</script>

</body>
</html>
