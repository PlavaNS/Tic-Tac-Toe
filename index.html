<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- Pi Browser SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <!-- IMA HTML5 SDK za rewarded video oglase -->
  <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
  <style>
    :root {
      --bg: #f5f5f5;
      --text: #333333;
      --cell-bg: white;
      --hover-bg: #f0f0f0;
      --x-color: #2c3e50;
      --o-color: #e74c3c;
      --newgame-bg: #28a745;
      --pay-bg: #3498db;
      --btn-text: #fff;
    }
    body.dark {
      --bg: #111;
      --text: #f5f5f5;
      --cell-bg: #1e1e1e;
      --hover-bg: #333;
      --x-color: #e1e5eb;
      --o-color: #e74c3c;
      --newgame-bg: #28a745;
      --pay-bg: #e1e5eb;
      --btn-text: #111;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 12px;
      margin: 40px 0;
    }
    .cell {
      background: var(--cell-bg);
      border: 2px solid #ccc;
      border-radius: 12px;
      font-size: 4rem;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      color: var(--x-color);
    }
    .cell:hover { background: var(--hover-bg); }
    .X { color: var(--x-color); }
    .O { color: var(--o-color); }
    .win.X, .win.O {
      animation: strongShake 0.6s ease-in-out;
      box-shadow: 0 0 10px var(--newgame-bg);
    }
    @keyframes strongShake {
      0%,100% { transform: translate(0,0); }
      10% { transform: translate(-8px,0); }
      20% { transform: translate(8px,0); }
      30% { transform: translate(-6px,0); }
      40% { transform: translate(6px,0); }
      50% { transform: translate(-4px,0); }
      60% { transform: translate(4px,0); }
      70% { transform: translate(-2px,0); }
      80% { transform: translate(2px,0); }
    }
    button {
      font-size: 1.2rem;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
    }
    #newGameBtn {
      background: white;
      color: black;
      display: none;
    }
    #newGameBtn.visible {
      display: block;
    }
    body.dark #newGameBtn {
      background: white;
      color: black;
    }
    #payBtn {
      background: var(--pay-bg);
      color: var(--btn-text);
    }
    #brushIcon, #darkToggle svg {
      filter: invert(0) grayscale(100%);
      transition: filter 0.3s ease;
    }
    body.dark #brushIcon, body.dark #darkToggle svg {
      filter: invert(1) grayscale(100%);
    }
    #brushIcon, #darkToggle {
      position: fixed;
      bottom: 20px;
      width: 42px;
      height: 42px;
      cursor: pointer;
      z-index: 1000;
    }
    #brushIcon { left: 20px; }
    #darkToggle {
      right: 20px;
      background: none;
      border: none;
      padding: 0;
    }
    #darkToggle svg { width: 100%; height: 100%; display: block; }
  </style>
</head>
<body>
  <div id="game"></div>
  <audio id="clickAudio" src="mixkit-modern-technology-select-3124.wav" preload="auto"></audio>
  <audio id="botAudio" src="mixkit-modern-technology-select-3124.wav" preload="auto"></audio>
  <audio id="winAudio" src="correct.mp3" preload="auto"></audio>
  <button id="newGameBtn">New Game</button>
  <button id="payBtn" disabled>Pay with Pi</button>
  <img id="brushIcon" src="theme.png" alt="Brush Icon">
  <button id="darkToggle" aria-label="Toggle Dark Mode">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64 13.06A9 9 0 0 1 11 2a9 9 0 1 0 10.64 11.06z"/></svg>
  </button>
  <script>
    const root = document.documentElement;
    const originalVars = {
      '--bg': getComputedStyle(root).getPropertyValue('--bg'),
      '--text': getComputedStyle(root).getPropertyValue('--text'),
      '--cell-bg': getComputedStyle(root).getPropertyValue('--cell-bg'),
      '--hover-bg': getComputedStyle(root).getPropertyValue('--hover-bg'),
      '--x-color': getComputedStyle(root).getPropertyValue('--x-color'),
      '--o-color': getComputedStyle(root).getPropertyValue('--o-color')
    };
    const winCombos = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    let board = Array(9).fill(''); let currentPlayer = 'X'; let gameOver = false; let gameCount = 0;
    const clickAudio = document.getElementById('clickAudio');
    const botAudio = document.getElementById('botAudio');
    const winAudio = document.getElementById('winAudio');
    function renderBoard() {
      const gameDiv = document.getElementById('game'); gameDiv.innerHTML = '';
      board.forEach((val,i)=>{ const cell=document.createElement('div'); cell.className='cell '+val; cell.textContent=val; cell.addEventListener('click',()=>handlePlayerMove(i)); gameDiv.appendChild(cell); });
    }
    function handlePlayerMove(i){ if(gameOver||board[i]||currentPlayer!=='X') return; clickAudio.play(); board[i]='X'; renderBoard(); if(checkWin('X')||checkDraw()) return endRound(); currentPlayer='O'; setTimeout(botMove,400);}    
    function botMove(){ if(gameOver) return; let move=getBestMove('O')||getBestMove('X'); if(move==null){ const empties=board.map((v,i)=>v===''?i:null).filter(n=>n!=null); move=empties[Math.floor(Math.random()*empties.length)]; } botAudio.play(); board[move]='O'; renderBoard(); if(checkWin('O')||checkDraw()) return endRound(); currentPlayer='X'; }
    function getBestMove(p){ for(const c of winCombos){ const [a,b,c2]=c; const line=[board[a],board[b],board[c2]]; if(line.filter(x=>x===p).length===2&&line.includes('')) return c[line.indexOf('')]; } return null;}    
    function checkWin(p){ if(winCombos.some(c=>c.every(i=>board[i]===p))){ winAudio.play(); highlightWin(p); return true;} return false; }
    function checkDraw(){ return board.every(v=>v!==''); }
    function highlightWin(p){ const cells=document.querySelectorAll('.cell'); winCombos.forEach(c=>{ if(c.every(i=>board[i]===p)) c.forEach(i=>cells[i].classList.add('win',p)); }); }
    function endRound(){ gameOver=true; document.getElementById('newGameBtn').classList.add('visible'); }
    function startNewGame(){ board=Array(9).fill(''); gameOver=false; gameCount++; currentPlayer=gameCount%2?'X':'O'; document.getElementById('newGameBtn').classList.remove('visible'); renderBoard(); if(currentPlayer==='O') setTimeout(botMove,400);}    
    function toggleDarkMode(){ const isDark=document.body.classList.toggle('dark'); if(!isDark){ for(const[prop,val] of Object.entries(originalVars)) root.style.setProperty(prop,val);} }
    function toggleBrushTheme(){ const rand=()=>'#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); root.style.setProperty('--bg',rand()); root.style.setProperty('--cell-bg','#fff'); root.style.setProperty('--hover-bg','#f0f0f0'); root.style.setProperty('--x-color',rand()); root.style.setProperty('--o-color',rand()); }
    function onIncompletePaymentFound(payment){ Pi.completePayment(payment.id).catch(console.error);}    
    function processPiPayment(){ if(!window.piUserAuthenticated) return; Pi.createPayment({amount:0.01,memo:'Tic Tac Toe Game',metadata:{purpose:'Game Payment'}},{onReadyForServerApproval:id=>Pi.completePayment(id).catch(console.error),onReadyForServerCompletion:(id,tx)=>console.log('Done',id,tx),onCancel:id=>console.log('Cancelled',id),onError:(e,p)=>console.error('Err',e,p)}); }
    window.addEventListener('DOMContentLoaded',()=>{ renderBoard(); startNewGame(); document.getElementById('newGameBtn').addEventListener('click',startNewGame); document.getElementById('brushIcon').addEventListener('click',toggleBrushTheme); document.getElementById('darkToggle').addEventListener('click',toggleDarkMode); document.getElementById('payBtn').addEventListener('click',processPiPayment); Pi.init({version:'2.0',sandbox:true}); Pi.authenticate(['payments'],onIncompletePaymentFound).then(()=>window.piUserAuthenticated=true).catch(console.error); });
  </script>
</body>
</html>
